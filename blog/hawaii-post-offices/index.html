<!DOCTYPE html>
<html lang="en" dir="ltr"><head>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.91.2" />
<title>Which #TidyTuesday post offices are in Hawaii? | Julia Silge</title>


<meta property="twitter:site" content="@juliasilge">
<meta property="twitter:creator" content="@juliasilge">







  
    
  
<meta name="description" content="A data science blog">


<meta property="og:site_name" content="Julia Silge">
<meta property="og:title" content="Which #TidyTuesday post offices are in Hawaii? | Julia Silge">
<meta property="og:description" content="A data science blog" />
<meta property="og:type" content="page" />
<meta property="og:url" content="https://juliasilge.com/blog/hawaii-post-offices/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="https://juliasilge.com/blog/hawaii-post-offices/featured.png" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https://juliasilge.com/blog/hawaii-post-offices/featured.png" >
    
    
  <meta itemprop="name" content="Which #TidyTuesday post offices are in Hawaii?">
<meta itemprop="description" content="Use tidymodels to predict post office location with subword features and a support vector machine model."><meta itemprop="datePublished" content="2021-04-14T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-04-14T00:00:00+00:00" />
<meta itemprop="wordCount" content="2045"><meta itemprop="image" content="https://juliasilge.com/blog/hawaii-post-offices/featured.png">
<meta itemprop="keywords" content="rstats,tidymodels," />
  
  
  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/icon.png" type="image/x-icon">
  <link rel="icon" href="/img/icon.png" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.34750661ca065ca7ddb87b2b28cab82abf493a21c1e3852e0755fba776b031b7.css" integrity="sha256-NHUGYcoGXKfduHsrKMq4Kr9JOiHB44UuB1X7p3awMbc=" media="screen">
  
  
  <script src="/panelset.min.078a92db9bd3228df502db3d9e0453c3cf3d910abe3f8deca0ad196c7071ad41.js" type="text/javascript"></script>
  
  
  <script src="/main.min.bb67dea4a2ee41aab688effd180f2d02662e47280f0021495f2c0ce24c461f65.js" type="text/javascript"></script>
</head>
<body>
      <div class="grid-container">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="https://juliasilge.com/" title="Home">
      <span class="f4 fw7">Julia Silge</span>
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About me">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4">Which #TidyTuesday post offices are in Hawaii?</h1>
        
        <p class="f6 measure lh-copy mv1">By Julia Silge in <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </p>
        <p class="f7 db mv0 ttu">April 14, 2021</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>This is the latest in my series of 
<a href="https://juliasilge.com/category/tidymodels/" target="_blank" rel="noopener">screencasts</a> demonstrating how to use the 
<a href="https://www.tidymodels.org/" target="_blank" rel="noopener">tidymodels</a> packages, from starting out with first modeling steps to tuning more complex models. Today’s screencast walks through how to use text information at the subword level in predictive modeling, with this week’s 
<a href="https://github.com/rfordatascience/tidytuesday" target="_blank" rel="noopener"><code>#TidyTuesday</code> dataset</a> on United States post offices. 📬</p>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube-nocookie.com/embed/RA5SyY-s-AA" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
</br>
<p>Here is the code I used in the video, for those who prefer reading instead of or in addition to video.</p>




<h2 id="explore-data">Explore data
  <a href="#explore-data"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Our modeling goal is to predict whether a post office is in Hawaii or not 
<a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2021/2021-04-13/readme.md" target="_blank" rel="noopener">based on the name of the office in this week’s #TidyTuesday dataset</a>.</p>
<p>Let’s start by reading in the data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidyverse)

post_offices <span style="color:#666">&lt;-</span> <span style="color:#06287e">read_csv</span>(<span style="color:#4070a0">&#34;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-13/post_offices.csv&#34;</span>)
</code></pre></div><p>How many post offices are there in each state?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">post_offices <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">count</span>(state, sort <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">TRUE</span>)
</code></pre></div><pre><code>## # A tibble: 53 x 2
##    state     n
##    &lt;chr&gt; &lt;int&gt;
##  1 PA     8534
##  2 TX     7772
##  3 KY     7432
##  4 VA     7085
##  5 NC     6547
##  6 MO     6232
##  7 NY     6111
##  8 TN     6025
##  9 GA     5754
## 10 OH     5537
## # … with 43 more rows
</code></pre>
<p>In Hawaii, the names of the post offices are unique, but there are not many at all, compared to the other states.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">post_offices <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(state <span style="color:#666">==</span> <span style="color:#4070a0">&#34;HI&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">pull</span>(name)
</code></pre></div><pre><code>##   [1] &quot;AIEA&quot;                 &quot;ANAHOLA&quot;              &quot;CANTON ISLAND&quot;       
##   [4] &quot;CAPTAIN COOK&quot;         &quot;COCONUT ISLAND&quot;       &quot;ELEELE&quot;              
##   [7] &quot;EWA&quot;                  &quot;EWA BEACH&quot;            &quot;FERNDALE&quot;            
##  [10] &quot;FORT KAMEHAMEHA&quot;      &quot;FORT SHAFTER&quot;         &quot;GLENWOOD&quot;            
##  [13] &quot;HAIKU&quot;                &quot;HAINA&quot;                &quot;HAIULA&quot;              
##  [16] &quot;HAKALAU&quot;              &quot;HALAULA&quot;              &quot;HALAWA&quot;              
##  [19] &quot;HALEIWA&quot;              &quot;HALEIWA&quot;              &quot;HALIIMAILE RURAL BR.&quot;
##  [22] &quot;HAMAKUA&quot;              &quot;HAMAKUAPOKO&quot;          &quot;HAMOA&quot;               
##  [25] &quot;HANA&quot;                 &quot;HANALEI&quot;              &quot;HANAMAULU&quot;           
##  [28] &quot;HANAPEPE&quot;             &quot;HATANLA&quot;              &quot;HAUULA&quot;              
##  [31] &quot;HAUULA&quot;               &quot;HAWAII NATIONAL PARK&quot; &quot;HAWI&quot;                
##  [34] &quot;HEEIA&quot;                &quot;HICKAM FIELD BR.&quot;     &quot;HILEA&quot;               
##  [37] &quot;HILO&quot;                 &quot;HOLUALOA&quot;             &quot;HOMESTEAD&quot;           
##  [40] &quot;HONALUA&quot;              &quot;HONAUNAU&quot;             &quot;HONOKAA&quot;             
##  [43] &quot;HONOKOHAU&quot;            &quot;HONOKOHUA&quot;            &quot;HONOLUA&quot;             
##  [46] &quot;HONOLULU&quot;             &quot;HONOMU&quot;               &quot;HONOULIULI&quot;          
##  [49] &quot;HONUAPO&quot;              &quot;HOOKENA&quot;              &quot;HOOLEHUA&quot;            
##  [52] &quot;HOOPULOA&quot;             &quot;HUEHUE&quot;               &quot;HUELO&quot;               
##  [55] &quot;KAAAWA&quot;               &quot;KAALAEA&quot;              &quot;KAANAPALI&quot;           
##  [58] &quot;KAHAKULOA&quot;            &quot;KAHANA&quot;               &quot;KAHUKU&quot;              
##  [61] &quot;KAHULUI&quot;              &quot;KAI MALINO&quot;           &quot;KAILUA&quot;              
##  [64] &quot;KAILUA KONA&quot;          &quot;KALAE&quot;                &quot;KALAHEO&quot;             
##  [67] &quot;KALAPANA&quot;             &quot;KALAPANA&quot;             &quot;KALAUPAPA&quot;           
##  [70] &quot;KALAWAO&quot;              &quot;KALOA&quot;                &quot;KAMALO&quot;              
##  [73] &quot;KAMUELA&quot;              &quot;KANEOHE&quot;              &quot;KAPAA&quot;               
##  [76] &quot;KAPAA&quot;                &quot;KAPAAU&quot;               &quot;KAPOHO&quot;              
##  [79] &quot;KAPOLEI&quot;              &quot;KAULAWAI&quot;             &quot;KAUMAKANI&quot;           
##  [82] &quot;KAUNAKAKAI&quot;           &quot;KAUPO&quot;                &quot;KAWAIHAE&quot;            
##  [85] &quot;KAWAILOA&quot;             &quot;KEAAU&quot;                &quot;KEAAU&quot;               
##  [88] &quot;KEAHUA&quot;               &quot;KEALAKEKUA&quot;           &quot;KEALIA&quot;              
##  [91] &quot;KEANAE&quot;               &quot;KEAUHOU&quot;              &quot;KEKAHA&quot;              
##  [94] &quot;KEOKEA&quot;               &quot;KEOMUKU&quot;              &quot;KIHEI&quot;               
##  [97] &quot;KILAUEA&quot;              &quot;KIPAHULU&quot;             &quot;KOHALA&quot;              
## [100] &quot;KOLOA&quot;                &quot;KONA&quot;                 &quot;KUALAPUU&quot;            
## [103] &quot;KUKUAIAU&quot;             &quot;KUKUIHAELE&quot;           &quot;KUNIA&quot;               
## [106] &quot;KURTISTOWN&quot;           &quot;LAHAINA&quot;              &quot;LAIE&quot;                
## [109] &quot;LALAMILO&quot;             &quot;LANAI CITY&quot;           &quot;LANIKAI&quot;             
## [112] &quot;LAUPAHOEHOE&quot;          &quot;LAWAI&quot;                &quot;LIBBYVILLE&quot;          
## [115] &quot;LIHUE&quot;                &quot;LUKE FIELD BR.&quot;       &quot;MAHUKONA&quot;            
## [118] &quot;MAKAWAO&quot;              &quot;MAKAWELI&quot;             &quot;MAKENA&quot;              
## [121] &quot;MAKUA&quot;                &quot;MANA&quot;                 &quot;MAUNA LOA&quot;           
## [124] &quot;MAUNALOA&quot;             &quot;MAUNAWEI&quot;             &quot;MIDWAY ISLAND&quot;       
## [127] &quot;MOUNTAINVIEW&quot;         &quot;NAALEHU&quot;              &quot;NAHIKU&quot;              
## [130] &quot;NAHIKU&quot;               &quot;NANAKULI&quot;             &quot;NANAKULI&quot;            
## [133] &quot;NAPOOPOO&quot;             &quot;NINOLE&quot;               &quot;OLAA&quot;                
## [136] &quot;OLLA PLANTATION&quot;      &quot;OLOWALU&quot;              &quot;OOKALA&quot;              
## [139] &quot;OPIHIKAO&quot;             &quot;PAAUHAU&quot;              &quot;PAAUILO&quot;             
## [142] &quot;PAHALA&quot;               &quot;PAHOA&quot;                &quot;PAIA&quot;                
## [145] &quot;PAPAALOA&quot;             &quot;PAPAIKOU&quot;             &quot;PAPAIKOU&quot;            
## [148] &quot;PAUWELA&quot;              &quot;PEAHI&quot;                &quot;PEARL CITY&quot;          
## [151] &quot;PEARL HARBOR&quot;         &quot;PEARL HARBOR&quot;         &quot;PELEKUNU&quot;            
## [154] &quot;PEPEEKEO&quot;             &quot;POHOKI&quot;               &quot;PRINCEVILLE&quot;         
## [157] &quot;PUHI&quot;                 &quot;PUKALANI&quot;             &quot;PUKOO&quot;               
## [160] &quot;PUKOO&quot;                &quot;PUNALUU&quot;              &quot;PUULOA HALE BR.&quot;     
## [163] &quot;PUUNENE&quot;              &quot;ROOSEVELT&quot;            &quot;SCHOFIELD BARRACKS&quot;  
## [166] &quot;SPRECKELSVILLE&quot;       &quot;SPRECKELSVILLE&quot;       &quot;SUNSET BEACH&quot;        
## [169] &quot;ULUPALAKUA&quot;           &quot;ULUPALAKUA&quot;           &quot;VOLCANO&quot;             
## [172] &quot;VOLCANO HOUSE&quot;        &quot;WAHIAWA&quot;              &quot;WAIAHOLE&quot;            
## [175] &quot;WAIAKOA&quot;              &quot;WAIALEE&quot;              &quot;WAIALUA&quot;             
## [178] &quot;WAIANAE&quot;              &quot;WAIHEE&quot;               &quot;WAIHEE&quot;              
## [181] &quot;WAIKANE&quot;              &quot;WAIKAUPU&quot;             &quot;WAIKOLOA&quot;            
## [184] &quot;WAILUKU&quot;              &quot;WAIMANALO&quot;            &quot;WAIMEA&quot;              
## [187] &quot;WAIMEA&quot;               &quot;WAINIHA&quot;              &quot;WAIOHINU&quot;            
## [190] &quot;WAIPAHU&quot;              &quot;WAIPIO&quot;               &quot;WATERTOWN&quot;
</code></pre>




<h2 id="build-a-model">Build a model
  <a href="#build-a-model"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>We can start by loading the tidymodels metapackage, splitting our data into training and testing sets, and creating cross-validation samples. Think about this stage as <em>spending your data budget</em>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidymodels)

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">123</span>)
po_split <span style="color:#666">&lt;-</span> post_offices <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(state <span style="color:#666">=</span> <span style="color:#06287e">case_when</span>(
    state <span style="color:#666">==</span> <span style="color:#4070a0">&#34;HI&#34;</span> <span style="color:#666">~</span> <span style="color:#4070a0">&#34;Hawaii&#34;</span>,
    <span style="color:#007020;font-weight:bold">TRUE</span> <span style="color:#666">~</span> <span style="color:#4070a0">&#34;Other&#34;</span>
  )) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">select</span>(name, state) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">initial_split</span>(strate <span style="color:#666">=</span> state)

po_train <span style="color:#666">&lt;-</span> <span style="color:#06287e">training</span>(po_split)
po_test <span style="color:#666">&lt;-</span> <span style="color:#06287e">testing</span>(po_split)

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">234</span>)
po_folds <span style="color:#666">&lt;-</span> <span style="color:#06287e">vfold_cv</span>(po_train, strata <span style="color:#666">=</span> state)
po_folds
</code></pre></div><pre><code>## #  10-fold cross-validation using stratification 
## # A tibble: 10 x 2
##    splits                 id    
##    &lt;list&gt;                 &lt;chr&gt; 
##  1 &lt;split [112144/12461]&gt; Fold01
##  2 &lt;split [112144/12461]&gt; Fold02
##  3 &lt;split [112144/12461]&gt; Fold03
##  4 &lt;split [112144/12461]&gt; Fold04
##  5 &lt;split [112144/12461]&gt; Fold05
##  6 &lt;split [112145/12460]&gt; Fold06
##  7 &lt;split [112145/12460]&gt; Fold07
##  8 &lt;split [112145/12460]&gt; Fold08
##  9 &lt;split [112145/12460]&gt; Fold09
## 10 &lt;split [112145/12460]&gt; Fold10
</code></pre>
<p>Next, let’s create our feature engineering recipe. Let’s tokenize using 
<a href="https://en.wikipedia.org/wiki/Byte_pair_encoding" target="_blank" rel="noopener">byte pair encoding</a>; this is an algorithm that iteratively merges frequently occurring subword pairs and gets us information in between character-level and word-level. You can read more about byte pair encoding in 
<a href="https://smltar.com/dlcnn.html#case-study-byte-pair-encoding" target="_blank" rel="noopener">this section of <em>Supervised Machine Learning for Text Analysis in R</em></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(textrecipes)
<span style="color:#06287e">library</span>(themis)

po_rec <span style="color:#666">&lt;-</span> <span style="color:#06287e">recipe</span>(state <span style="color:#666">~</span> name, data <span style="color:#666">=</span> po_train) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_tokenize</span>(name,
    engine <span style="color:#666">=</span> <span style="color:#4070a0">&#34;tokenizers.bpe&#34;</span>,
    training_options <span style="color:#666">=</span> <span style="color:#06287e">list</span>(vocab_size <span style="color:#666">=</span> <span style="color:#40a070">200</span>)
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_tokenfilter</span>(name, max_tokens <span style="color:#666">=</span> <span style="color:#40a070">200</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_tf</span>(name) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_normalize</span>(<span style="color:#06287e">all_predictors</span>()) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_smote</span>(state)

po_rec
</code></pre></div><pre><code>## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          1
## 
## Operations:
## 
## Tokenization for name
## Text filtering for name
## Term frequency with name
## Centering and scaling for all_predictors()
## SMOTE based on state
</code></pre>
<p>We also are upsampling this very imbalanced data set via <code>step_smote()</code> from the 
<a href="https://themis.tidymodels.org/" target="_blank" rel="noopener">themis</a> package. The results of this data preprocessing show us the subword features.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">po_rec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">prep</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bake</span>(new_data <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>)
</code></pre></div><pre><code>## # A tibble: 248,932 x 201
##    `tf_name_-` tf_name_. `tf_name_'` `tf_name_'S` `tf_name_/` `tf_name_&amp;`
##          &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  2     -0.0203  102.         -0.0346       -0.165     -0.0102    -0.00567
##  3     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  4     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  5     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  6     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  7     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  8     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
##  9     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
## 10     -0.0203   -0.0184     -0.0346       -0.165     -0.0102    -0.00567
## # … with 248,922 more rows, and 195 more variables: tf_name_` &lt;dbl&gt;,
## #   tf_name_▁ &lt;dbl&gt;, tf_name_▁A &lt;dbl&gt;, tf_name_▁AL &lt;dbl&gt;, tf_name_▁B &lt;dbl&gt;,
## #   tf_name_▁BE &lt;dbl&gt;, tf_name_▁BL &lt;dbl&gt;, tf_name_▁BR &lt;dbl&gt;, tf_name_▁C &lt;dbl&gt;,
## #   tf_name_▁CENT &lt;dbl&gt;, tf_name_▁CH &lt;dbl&gt;, tf_name_▁CITY &lt;dbl&gt;,
## #   tf_name_▁CL &lt;dbl&gt;, tf_name_▁CO &lt;dbl&gt;, tf_name_▁CREEK &lt;dbl&gt;,
## #   tf_name_▁D &lt;dbl&gt;, tf_name_▁E &lt;dbl&gt;, tf_name_▁EL &lt;dbl&gt;, tf_name_▁F &lt;dbl&gt;,
## #   tf_name_▁G &lt;dbl&gt;, tf_name_▁GRO &lt;dbl&gt;, tf_name_▁GROVE &lt;dbl&gt;,
## #   tf_name_▁H &lt;dbl&gt;, tf_name_▁HILL &lt;dbl&gt;, tf_name_▁J &lt;dbl&gt;, tf_name_▁K &lt;dbl&gt;,
## #   tf_name_▁L &lt;dbl&gt;, tf_name_▁LAKE &lt;dbl&gt;, tf_name_▁LE &lt;dbl&gt;, tf_name_▁M &lt;dbl&gt;,
## #   tf_name_▁MILL &lt;dbl&gt;, tf_name_▁MILLS &lt;dbl&gt;, tf_name_▁MO &lt;dbl&gt;,
## #   tf_name_▁MOUNT &lt;dbl&gt;, tf_name_▁N &lt;dbl&gt;, tf_name_▁NEW &lt;dbl&gt;,
## #   tf_name_▁NOR &lt;dbl&gt;, tf_name_▁O &lt;dbl&gt;, tf_name_▁P &lt;dbl&gt;, tf_name_▁PO &lt;dbl&gt;,
## #   tf_name_▁R &lt;dbl&gt;, tf_name_▁RI &lt;dbl&gt;, tf_name_▁RO &lt;dbl&gt;, tf_name_▁S &lt;dbl&gt;,
## #   tf_name_▁SH &lt;dbl&gt;, tf_name_▁SP &lt;dbl&gt;, tf_name_▁SPRING &lt;dbl&gt;,
## #   tf_name_▁SPRINGS &lt;dbl&gt;, tf_name_▁ST &lt;dbl&gt;, tf_name_▁T &lt;dbl&gt;,
## #   tf_name_▁V &lt;dbl&gt;, tf_name_▁W &lt;dbl&gt;, tf_name_▁WEST &lt;dbl&gt;, tf_name_▁WH &lt;dbl&gt;,
## #   tf_name_1 &lt;dbl&gt;, tf_name_A &lt;dbl&gt;, tf_name_AD &lt;dbl&gt;, tf_name_AG &lt;dbl&gt;,
## #   tf_name_AK &lt;dbl&gt;, tf_name_AKE &lt;dbl&gt;, tf_name_AL &lt;dbl&gt;, tf_name_ALE &lt;dbl&gt;,
## #   tf_name_ALL &lt;dbl&gt;, tf_name_AM &lt;dbl&gt;, tf_name_AN &lt;dbl&gt;, tf_name_AND &lt;dbl&gt;,
## #   tf_name_ANT &lt;dbl&gt;, tf_name_AP &lt;dbl&gt;, tf_name_AR &lt;dbl&gt;, tf_name_ARD &lt;dbl&gt;,
## #   tf_name_ARK &lt;dbl&gt;, tf_name_ART &lt;dbl&gt;, tf_name_AS &lt;dbl&gt;, tf_name_AST &lt;dbl&gt;,
## #   tf_name_AT &lt;dbl&gt;, tf_name_ATION &lt;dbl&gt;, tf_name_AW &lt;dbl&gt;, tf_name_AY &lt;dbl&gt;,
## #   tf_name_B &lt;dbl&gt;, tf_name_BER &lt;dbl&gt;, tf_name_BUR &lt;dbl&gt;, tf_name_BURG &lt;dbl&gt;,
## #   tf_name_C &lt;dbl&gt;, tf_name_CE &lt;dbl&gt;, tf_name_CH &lt;dbl&gt;, tf_name_CK &lt;dbl&gt;,
## #   tf_name_CO &lt;dbl&gt;, tf_name_D &lt;dbl&gt;, tf_name_E &lt;dbl&gt;, tf_name_ED &lt;dbl&gt;,
## #   tf_name_EE &lt;dbl&gt;, tf_name_EL &lt;dbl&gt;, tf_name_ELD &lt;dbl&gt;, tf_name_ELL &lt;dbl&gt;,
## #   tf_name_EN &lt;dbl&gt;, tf_name_ENT &lt;dbl&gt;, tf_name_ER &lt;dbl&gt;, tf_name_ERS &lt;dbl&gt;,
## #   tf_name_ES &lt;dbl&gt;, tf_name_EST &lt;dbl&gt;, …
</code></pre>
<p>Next let’s create a model specification for a linear support vector machine. This is a newer model in parsnip, currently in the development version on GitHub. Linear SVMs are often a good starting choice for text models.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">svm_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">svm_linear</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_mode</span>(<span style="color:#4070a0">&#34;classification&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(<span style="color:#4070a0">&#34;LiblineaR&#34;</span>)

svm_spec
</code></pre></div><pre><code>## Linear Support Vector Machine Specification (classification)
## 
## Computational engine: LiblineaR
</code></pre>
<p>Let’s put these together in a workflow.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">po_wf <span style="color:#666">&lt;-</span> <span style="color:#06287e">workflow</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">add_recipe</span>(po_rec) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">add_model</span>(svm_spec)

po_wf
</code></pre></div><pre><code>## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: svm_linear()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 5 Recipe Steps
## 
## ● step_tokenize()
## ● step_tokenfilter()
## ● step_tf()
## ● step_normalize()
## ● step_smote()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Linear Support Vector Machine Specification (classification)
## 
## Computational engine: LiblineaR
</code></pre>
<p>Now let’s fit this workflow (that combines feature engineering with the SVM model) to the resamples we created earlier. The linear SVM model does not support class probabilities, so we need to set a custom <code>metric_set()</code> that only includes metrics for hard clss probabilities.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">set.seed</span>(<span style="color:#40a070">234</span>)

doParallel<span style="color:#666">::</span><span style="color:#06287e">registerDoParallel</span>()
po_rs <span style="color:#666">&lt;-</span> <span style="color:#06287e">fit_resamples</span>(
  po_wf,
  po_folds,
  metrics <span style="color:#666">=</span> <span style="color:#06287e">metric_set</span>(accuracy, sens, spec)
)
</code></pre></div><p>How did we do?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">collect_metrics</span>(po_rs)
</code></pre></div><pre><code>## # A tibble: 3 x 6
##   .metric  .estimator  mean     n  std_err .config             
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
## 1 accuracy binary     0.971    10 0.000763 Preprocessor1_Model1
## 2 sens     binary     0.755    10 0.0386   Preprocessor1_Model1
## 3 spec     binary     0.972    10 0.000791 Preprocessor1_Model1
</code></pre>
<p>Not too bad, although you can tell we are doing better on one class than the other.</p>




<h2 id="fit-and-evaluate-final-model">Fit and evaluate final model
  <a href="#fit-and-evaluate-final-model"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Next, let’s fit our model on last time to the <strong>whole</strong> training set at once (rather than resampled data) and evaluate on the testing set. This is the first time we have touched the testing set.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">final_fitted <span style="color:#666">&lt;-</span> <span style="color:#06287e">last_fit</span>(
  po_wf,
  po_split,
  metrics <span style="color:#666">=</span> <span style="color:#06287e">metric_set</span>(accuracy, sens, spec)
)
<span style="color:#06287e">collect_metrics</span>(final_fitted)
</code></pre></div><pre><code>## # A tibble: 3 x 4
##   .metric  .estimator .estimate .config             
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
## 1 accuracy binary         0.969 Preprocessor1_Model1
## 2 sens     binary         0.811 Preprocessor1_Model1
## 3 spec     binary         0.969 Preprocessor1_Model1
</code></pre>
<p>Our performance on the testing set is about the same as what we found with our resampled data, which is good.</p>
<p>We can explore how the model is doing for both the positive and negative classes with a confusion matrix.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">collect_predictions</span>(final_fitted) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">conf_mat</span>(state, .pred_class)
</code></pre></div><pre><code>##           Truth
## Prediction Hawaii Other
##     Hawaii     43  1273
##     Other      10 40209
</code></pre>
<p>This just really emphasizes what an imbalanced problem this is, but we can see how well we are doing for the post offices in Hawaii vs. the rest of the country.</p>
<p>We are still in the process of building out support for exploring results for the LiblineaR model (like a <code>tidy()</code> method) but in the meantime, you can get out the linear coefficients manually.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">po_fit <span style="color:#666">&lt;-</span> <span style="color:#06287e">pull_workflow_fit</span>(final_fitted<span style="color:#666">$</span>.workflow[[1]])
liblinear_obj <span style="color:#666">&lt;-</span> po_fit<span style="color:#666">$</span>fit<span style="color:#666">$</span>W
liblinear_df <span style="color:#666">&lt;-</span> <span style="color:#06287e">tibble</span>(
  term <span style="color:#666">=</span> <span style="color:#06287e">colnames</span>(liblinear_obj),
  estimate <span style="color:#666">=</span> liblinear_obj[1, ]
)
liblinear_df
</code></pre></div><pre><code>## # A tibble: 201 x 2
##    term        estimate
##    &lt;chr&gt;          &lt;dbl&gt;
##  1 tf_name_-    0.0814 
##  2 tf_name_.   -0.0664 
##  3 tf_name_'    0.0661 
##  4 tf_name_'S   0.495  
##  5 tf_name_/   -0.00675
##  6 tf_name_&amp;   -0.0198 
##  7 tf_name_`   -0.00264
##  8 tf_name_▁   -0.0419 
##  9 tf_name_▁A  -0.0868 
## 10 tf_name_▁AL  0.201  
## # … with 191 more rows
</code></pre>
<p>Those <code>term</code> items are the subwords that the byte pair encoding algorithm found for this data set. We can <code>arrange()</code> them to see which are most important in each direction.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">liblinear_df <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">arrange</span>(<span style="color:#666">-</span>estimate)
</code></pre></div><pre><code>## # A tibble: 201 x 2
##    term        estimate
##    &lt;chr&gt;          &lt;dbl&gt;
##  1 Bias           5.52 
##  2 tf_name_G      0.990
##  3 tf_name_▁D     0.975
##  4 tf_name_RI     0.820
##  5 tf_name_▁T     0.696
##  6 tf_name_AND    0.643
##  7 tf_name_IR     0.578
##  8 tf_name_GH     0.561
##  9 tf_name_VER    0.561
## 10 tf_name_AS     0.559
## # … with 191 more rows
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">liblinear_df <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">arrange</span>(estimate)
</code></pre></div><pre><code>## # A tibble: 201 x 2
##    term        estimate
##    &lt;chr&gt;          &lt;dbl&gt;
##  1 tf_name_A     -0.407
##  2 tf_name_I     -0.339
##  3 tf_name_O     -0.330
##  4 tf_name_AN    -0.320
##  5 tf_name_▁H    -0.319
##  6 tf_name_▁P    -0.281
##  7 tf_name_ALE   -0.280
##  8 tf_name_U     -0.259
##  9 tf_name_OWN   -0.258
## 10 tf_name_▁F    -0.222
## # … with 191 more rows
</code></pre>
<p>Or we can build a visualization.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">liblinear_df <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(term <span style="color:#666">!=</span> <span style="color:#4070a0">&#34;Bias&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">group_by</span>(estimate <span style="color:#666">&gt;</span> <span style="color:#40a070">0</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">slice_max</span>(<span style="color:#06287e">abs</span>(estimate), n <span style="color:#666">=</span> <span style="color:#40a070">15</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ungroup</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(term <span style="color:#666">=</span> <span style="color:#06287e">str_remove</span>(term, <span style="color:#4070a0">&#34;tf_name_&#34;</span>)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(estimate, <span style="color:#06287e">fct_reorder</span>(term, estimate), fill <span style="color:#666">=</span> estimate <span style="color:#666">&gt;</span> <span style="color:#40a070">0</span>)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_col</span>(alpha <span style="color:#666">=</span> <span style="color:#40a070">0.6</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_text</span>(<span style="color:#06287e">aes</span>(label <span style="color:#666">=</span> term), family <span style="color:#666">=</span> <span style="color:#4070a0">&#34;IBMPlexSans-Medium&#34;</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">scale_fill_discrete</span>(labels <span style="color:#666">=</span> <span style="color:#06287e">c</span>(<span style="color:#4070a0">&#34;More from Hawaii&#34;</span>, <span style="color:#4070a0">&#34;Less from Hawaii&#34;</span>)) <span style="color:#666">+</span>
  <span style="color:#06287e">scale_y_discrete</span>(breaks <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">theme</span>(axis.text.y <span style="color:#666">=</span> <span style="color:#06287e">element_blank</span>()) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Coefficient from linear SVM&#34;</span>,
    y <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>,
    fill <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>,
    title <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Which subwords in a US Post Office name are used more in Hawaii?&#34;</span>,
    subtitle <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Subwords like A, I, O, and AN are the strongest predictors of a post office being in Hawaii&#34;</span>
  )
</code></pre></div><img src="https://juliasilge.com/blog/hawaii-post-offices/index_files/figure-html/unnamed-chunk-16-1.png" width="2400" />

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">April 14, 2021</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">10 minute read, 2045 words</dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Categories:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Tags:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/tags/rstats">rstats</a>  <a href="https://juliasilge.com/tags/tidymodels">tidymodels</a> </dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
    <dd class="fw5 ml0"><a href="/blog/educational-attainment/">Educational attainment in #TidyTuesday UK towns</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/polling-places/">Changes in #TidyTuesday US polling places</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/doctor-who-bayes/">Empirical Bayes for #TidyTuesday Doctor Who episodes</a></dd>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
    <a class="prev dtc pr2 tl v-top fw6"
    href="https://juliasilge.com/blog/netflix-titles/">&larr; Which #TidyTuesday Netflix titles are movies and which are TV shows?</a>
  
  
  
    <a class="next dtc pl2 tr v-top fw6"
    href="https://juliasilge.com/blog/un-voting/">Dimensionality reduction of #TidyTuesday United Nations voting patterns &rarr;</a>
  
</div>

      </footer>
    </article>
    
      
<div class="post-comments pa0 pa4-l mt4">
  
  <script src="https://utteranc.es/client.js"
          repo="juliasilge/juliasilge.com"
          issue-term="title"
          theme="github-light"
          label="comments :speech_balloon:"
          crossorigin="anonymous"
          async
          type="text/javascript">
  </script>
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2024 Julia Silge
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
    </div>
  </nav>
  
    <script>

    var i, text, code, codes = document.getElementsByTagName('code');
    for (let i = 0; i < codes.length;) {
      code = codes[i];
      if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
        text = code.textContent;
        if (/^\$[^$]/.test(text) && /[^$]\$$/.test(text)) {
          text = text.replace(/^\$/, '\\(').replace(/\$$/, '\\)');
          code.textContent = text;
        }
        if (/^\\\((.|\s)+\\\)$/.test(text) ||
            /^\\\[(.|\s)+\\\]$/.test(text) ||
            /^\$(.|\s)+\$$/.test(text) ||
            /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
          code.outerHTML = code.innerHTML;  
          continue;
        }
      }
      i++;
    }
</script>

  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>



    
  
  
</footer>

      </div>
    </body>
</html>
