<!DOCTYPE html>
<html lang="en" dir="ltr"><head>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.91.2" />
<title>Preprocessing and resampling using #TidyTuesday college data | Julia Silge</title>


<meta property="twitter:site" content="@juliasilge">
<meta property="twitter:creator" content="@juliasilge">







  
    
  
<meta name="description" content="A data science blog">


<meta property="og:site_name" content="Julia Silge">
<meta property="og:title" content="Preprocessing and resampling using #TidyTuesday college data | Julia Silge">
<meta property="og:description" content="A data science blog" />
<meta property="og:type" content="page" />
<meta property="og:url" content="https://juliasilge.com/blog/tuition-resampling/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="https://juliasilge.com/img/illustrated_blog_avatar.png" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https://juliasilge.com/img/illustrated_blog_avatar.png" >
    
  <meta itemprop="name" content="Preprocessing and resampling using #TidyTuesday college data">
<meta itemprop="description" content="I&rsquo;ve been publishing screencasts demonstrating how to use the tidymodels framework, from first getting started to how to tune machine learning models. Today, I&rsquo;m using this week&rsquo;s #TidyTuesday dataset on college tuition and diversity at US colleges to show some data preprocessing steps and how to use resampling!
   Here is the code I used in the video, for those who prefer reading instead of or in addition to video."><meta itemprop="datePublished" content="2020-03-10T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-03-10T00:00:00+00:00" />
<meta itemprop="wordCount" content="2227">
<meta itemprop="keywords" content="rstats,tidymodels," />
  
  
  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/icon.png" type="image/x-icon">
  <link rel="icon" href="/img/icon.png" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.34750661ca065ca7ddb87b2b28cab82abf493a21c1e3852e0755fba776b031b7.css" integrity="sha256-NHUGYcoGXKfduHsrKMq4Kr9JOiHB44UuB1X7p3awMbc=" media="screen">
  
  
  <script src="/panelset.min.078a92db9bd3228df502db3d9e0453c3cf3d910abe3f8deca0ad196c7071ad41.js" type="text/javascript"></script>
  
  
  <script src="/main.min.bb67dea4a2ee41aab688effd180f2d02662e47280f0021495f2c0ce24c461f65.js" type="text/javascript"></script>
</head>
<body>
      <div class="grid-container">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="https://juliasilge.com/" title="Home">
      <span class="f4 fw7">Julia Silge</span>
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About me">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4">Preprocessing and resampling using #TidyTuesday college data</h1>
        
        <p class="f6 measure lh-copy mv1">By Julia Silge in <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </p>
        <p class="f7 db mv0 ttu">March 10, 2020</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>I&rsquo;ve been publishing 
<a href="https://juliasilge.com/tags/tidymodels/" target="_blank" rel="noopener">screencasts</a> demonstrating how to use the tidymodels framework, from first getting started to how to tune machine learning models. Today, I&rsquo;m using this week&rsquo;s 
<a href="https://github.com/rfordatascience/tidytuesday" target="_blank" rel="noopener"><code>#TidyTuesday</code> dataset</a> on college tuition and diversity at US colleges to show some data preprocessing steps and how to use resampling!</p>
<!--html_preserve-->
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube-nocookie.com/embed/s3TkvZM60iU" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
<!--/html_preserve-->
</br>
<p>Here is the code I used in the video, for those who prefer reading instead of or in addition to video.</p>




<h2 id="explore-the-data">Explore the data
  <a href="#explore-the-data"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Our modeling goal here is to predict which US colleges have higher proportions of minority students based on college data such as tuition from the 
<a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-03-10/readme.md" target="_blank" rel="noopener">#TidyTuesday dataset</a>. There are several related datasets this week, and this modeling analysis uses two of them.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidyverse)

tuition_cost <span style="color:#666">&lt;-</span> readr<span style="color:#666">::</span><span style="color:#06287e">read_csv</span>(<span style="color:#4070a0">&#34;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/tuition_cost.csv&#34;</span>)

diversity_raw <span style="color:#666">&lt;-</span> readr<span style="color:#666">::</span><span style="color:#06287e">read_csv</span>(<span style="color:#4070a0">&#34;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-10/diversity_school.csv&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(category <span style="color:#666">==</span> <span style="color:#4070a0">&#34;Total Minority&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(TotalMinority <span style="color:#666">=</span> enrollment <span style="color:#666">/</span> total_enrollment)
</code></pre></div><p>What is the distribution of total minority student population?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">diversity_school <span style="color:#666">&lt;-</span> diversity_raw <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(category <span style="color:#666">==</span> <span style="color:#4070a0">&#34;Total Minority&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(TotalMinority <span style="color:#666">=</span> enrollment <span style="color:#666">/</span> total_enrollment)

diversity_school <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(TotalMinority)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_histogram</span>(alpha <span style="color:#666">=</span> <span style="color:#40a070">0.7</span>, fill <span style="color:#666">=</span> <span style="color:#4070a0">&#34;midnightblue&#34;</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">scale_x_continuous</span>(labels <span style="color:#666">=</span> scales<span style="color:#666">::</span><span style="color:#06287e">percent_format</span>()) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;% of student population who identifies as any minority&#34;</span>)
</code></pre></div><img src="/blog/2020/2020-03-10-tuition-resampling_files/figure-html/unnamed-chunk-3-1.png" width="2400" />
<p>The median proportion of minority students for this dataset is 30%.</p>
<p>Let&rsquo;s build a dataset for modeling, joining the two dataframes we have. Let&rsquo;s also move from individual states in the US to US regions, as found in <code>state.region</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">university_df <span style="color:#666">&lt;-</span> diversity_school <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(category <span style="color:#666">==</span> <span style="color:#4070a0">&#34;Total Minority&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(TotalMinority <span style="color:#666">=</span> enrollment <span style="color:#666">/</span> total_enrollment) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">transmute</span>(
    diversity <span style="color:#666">=</span> <span style="color:#06287e">case_when</span>(
      TotalMinority <span style="color:#666">&gt;</span> <span style="color:#40a070">0.3</span> <span style="color:#666">~</span> <span style="color:#4070a0">&#34;high&#34;</span>,
      <span style="color:#007020;font-weight:bold">TRUE</span> <span style="color:#666">~</span> <span style="color:#4070a0">&#34;low&#34;</span>
    ),
    name, state,
    total_enrollment
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">inner_join</span>(tuition_cost <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">select</span>(
      name, type, degree_length,
      in_state_tuition<span style="color:#666">:</span>out_of_state_total
    )) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">left_join</span>(<span style="color:#06287e">tibble</span>(state <span style="color:#666">=</span> state.name, region <span style="color:#666">=</span> state.region)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">select</span>(<span style="color:#666">-</span>state, <span style="color:#666">-</span>name) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate_if</span>(is.character, factor)

skimr<span style="color:#666">::</span><span style="color:#06287e">skim</span>(university_df)
</code></pre></div><pre tabindex="0"><code>## ── Data Summary ────────────────────────
##                            Values
## Name                       university_df
## Number of rows             2159
## Number of columns          9
## _______________________
## Column type frequency:
##   factor                   4
##   numeric                  5
## ________________________
## Group variables            None
##
## ── Variable type: factor ───────────────────────────────────────────────────────
##   skim_variable n_missing complete_rate ordered n_unique
## 1 diversity             0             1 FALSE          2
## 2 type                  0             1 FALSE          3
## 3 degree_length         0             1 FALSE          2
## 4 region                0             1 FALSE          4
##   top_counts
## 1 low: 1241, hig: 918
## 2 Pub: 1145, Pri: 955, For: 59
## 3 4 Y: 1296, 2 Y: 863
## 4 Sou: 774, Nor: 543, Nor: 443, Wes: 399
##
## ── Variable type: numeric ──────────────────────────────────────────────────────
##   skim_variable        n_missing complete_rate   mean     sd    p0   p25   p50
## 1 total_enrollment             0             1  6184.  8264.    15  1352  3133
## 2 in_state_tuition             0             1 17044. 15461.   480  4695 10161
## 3 in_state_total               0             1 23545. 19782.   962  5552 17749
## 4 out_of_state_tuition         0             1 20798. 13725.   480  9298 17045
## 5 out_of_state_total           0             1 27299. 18221.  1376 11018 23036
##      p75  p100 hist
## 1  7644. 81459 ▇▁▁▁▁
## 2 28780  59985 ▇▂▂▁▁
## 3 38519  75003 ▇▅▂▂▁
## 4 29865  59985 ▇▆▅▂▁
## 5 40154  75003 ▇▅▅▂▁
</code></pre><p>How are some of these quantities related to the proportion of minority students at a college?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">university_df <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(type, in_state_tuition, fill <span style="color:#666">=</span> diversity)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_boxplot</span>(alpha <span style="color:#666">=</span> <span style="color:#40a070">0.8</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">scale_y_continuous</span>(labels <span style="color:#666">=</span> scales<span style="color:#666">::</span><span style="color:#06287e">dollar_format</span>()) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(x <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>, y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;In-State Tuition&#34;</span>, fill <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Diversity&#34;</span>)
</code></pre></div><img src="/blog/2020/2020-03-10-tuition-resampling_files/figure-html/unnamed-chunk-5-1.png" width="2400" />




<h2 id="build-models-with-recipes">Build models with recipes
  <a href="#build-models-with-recipes"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Now it is time for modeling! First, we split our data into training and testing sets. Then, we build a recipe for data preprocessing.</p>
<ul>
<li>First, we must tell the <code>recipe()</code> what our model is going to be (using a formula here) and what our training data is.</li>
<li>We then filter out variables that are too correlated with each other. We had several different ways of measuring the tuition in our dataset that are correlated with each other, and this step shows how to handle a situation like that.</li>
<li>We then convert the factor columns into (one or more) numeric binary (0 and 1) variables for the levels of the training data.</li>
<li>Next, we remove any numeric variables that have zero variance.</li>
<li>As a last step, we normalize (center and scale) the numeric variables. We need to do this because some of them are on very different scales from each other and a model we want to train is sensitive to this.</li>
<li>Finally, we <code>prep()</code> the <code>recipe()</code>. This means we actually do something with the steps and our training data; we estimate the required parameters from <code>uni_train</code> to implement these steps so this whole sequence can be applied later to another dataset.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidymodels)

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">1234</span>)
uni_split <span style="color:#666">&lt;-</span> <span style="color:#06287e">initial_split</span>(university_df, strata <span style="color:#666">=</span> diversity)
uni_train <span style="color:#666">&lt;-</span> <span style="color:#06287e">training</span>(uni_split)
uni_test <span style="color:#666">&lt;-</span> <span style="color:#06287e">testing</span>(uni_split)

uni_rec <span style="color:#666">&lt;-</span> <span style="color:#06287e">recipe</span>(diversity <span style="color:#666">~</span> ., data <span style="color:#666">=</span> uni_train) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_corr</span>(<span style="color:#06287e">all_numeric</span>()) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_dummy</span>(<span style="color:#06287e">all_nominal</span>(), <span style="color:#666">-</span><span style="color:#06287e">all_outcomes</span>()) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_zv</span>(<span style="color:#06287e">all_numeric</span>()) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">step_normalize</span>(<span style="color:#06287e">all_numeric</span>())

uni_prep <span style="color:#666">&lt;-</span> uni_rec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">prep</span>()

uni_prep
</code></pre></div><pre tabindex="0"><code>## Data Recipe
##
## Inputs:
##
##       role #variables
##    outcome          1
##  predictor          8
##
## Training data contained 1620 data points and no missing data.
##
## Operations:
##
## Correlation filter removed in_state_tuition, ... [trained]
## Dummy variables from type, degree_length, region [trained]
## Zero variance filter removed no terms [trained]
## Centering and scaling for total_enrollment, ... [trained]
</code></pre><p>Now it&rsquo;s time to <strong>specify</strong> and then <strong>fit</strong> our models. Here, we specify and fit three models:</p>
<ul>
<li>logistic regression</li>
<li>k-nearest neighbor</li>
<li>decision tree</li>
</ul>
<p>Check out what data we are training these models on: <code>juice(uni_rec)</code>. The recipe <code>uni_rec</code> contains all our transformations for data preprocessing and feature engineering, <em>as well as</em> the data these transformations were estimated from. When we <code>juice()</code> the recipe, we squeeze that training data back out, transformed in all the ways we specified.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">uni_juiced <span style="color:#666">&lt;-</span> <span style="color:#06287e">juice</span>(uni_prep)

glm_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">logistic_reg</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(<span style="color:#4070a0">&#34;glm&#34;</span>)

glm_fit <span style="color:#666">&lt;-</span> glm_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit</span>(diversity <span style="color:#666">~</span> ., data <span style="color:#666">=</span> uni_juiced)

glm_fit
</code></pre></div><pre tabindex="0"><code>## parsnip model object
##
## Fit time:  7ms
##
## Call:  stats::glm(formula = formula, family = stats::binomial, data = data)
##
## Coefficients:
##           (Intercept)       total_enrollment     out_of_state_total
##                0.3704                -0.4581                 0.5074
##          type_Private            type_Public  degree_length_X4.Year
##               -0.1656                 0.2058                 0.2082
##          region_South   region_North.Central            region_West
##               -0.5175                 0.3004                -0.5363
##
## Degrees of Freedom: 1619 Total (i.e. Null);  1611 Residual
## Null Deviance:	    2210
## Residual Deviance: 1859 	AIC: 1877
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">knn_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">nearest_neighbor</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(<span style="color:#4070a0">&#34;kknn&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_mode</span>(<span style="color:#4070a0">&#34;classification&#34;</span>)

knn_fit <span style="color:#666">&lt;-</span> knn_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit</span>(diversity <span style="color:#666">~</span> ., data <span style="color:#666">=</span> uni_juiced)

knn_fit
</code></pre></div><pre tabindex="0"><code>## parsnip model object
##
## Fit time:  54ms
##
## Call:
## kknn::train.kknn(formula = formula, data = data, ks = 5)
##
## Type of response variable: nominal
## Minimal misclassification: 0.3277778
## Best kernel: optimal
## Best k: 5
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">tree_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">decision_tree</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(<span style="color:#4070a0">&#34;rpart&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_mode</span>(<span style="color:#4070a0">&#34;classification&#34;</span>)

tree_fit <span style="color:#666">&lt;-</span> tree_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit</span>(diversity <span style="color:#666">~</span> ., data <span style="color:#666">=</span> uni_juiced)

tree_fit
</code></pre></div><pre tabindex="0"><code>## parsnip model object
##
## Fit time:  23ms
## n= 1620
##
## node), split, n, loss, yval, (yprob)
##       * denotes terminal node
##
##  1) root 1620 689 low (0.4253086 0.5746914)
##    2) region_North.Central&lt; 0.5346496 1192 586 high (0.5083893 0.4916107)
##      4) out_of_state_total&lt; -0.7087237 418 130 high (0.6889952 0.3110048) *
##      5) out_of_state_total&gt;=-0.7087237 774 318 low (0.4108527 0.5891473)
##       10) out_of_state_total&lt; 0.35164 362 180 low (0.4972376 0.5027624)
##         20) region_South&gt;=0.3002561 212  86 high (0.5943396 0.4056604)
##           40) degree_length_X4.Year&gt;=-0.2001293 172  62 high (0.6395349 0.3604651) *
##           41) degree_length_X4.Year&lt; -0.2001293 40  16 low (0.4000000 0.6000000) *
##         21) region_South&lt; 0.3002561 150  54 low (0.3600000 0.6400000)
##           42) region_West&gt;=0.8128302 64  28 high (0.5625000 0.4375000) *
##           43) region_West&lt; 0.8128302 86  18 low (0.2093023 0.7906977) *
##       11) out_of_state_total&gt;=0.35164 412 138 low (0.3349515 0.6650485)
##         22) region_West&gt;=0.8128302 88  38 high (0.5681818 0.4318182)
##           44) out_of_state_total&gt;=1.547681 30   5 high (0.8333333 0.1666667) *
##           45) out_of_state_total&lt; 1.547681 58  25 low (0.4310345 0.5689655) *
##         23) region_West&lt; 0.8128302 324  88 low (0.2716049 0.7283951) *
##    3) region_North.Central&gt;=0.5346496 428  83 low (0.1939252 0.8060748)
##      6) out_of_state_total&lt; -1.19287 17   5 high (0.7058824 0.2941176) *
##      7) out_of_state_total&gt;=-1.19287 411  71 low (0.1727494 0.8272506) *
</code></pre><p>Models! 🎉</p>




<h2 id="evaluate-models-with-resampling">Evaluate models with resampling
  <a href="#evaluate-models-with-resampling"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Well, we fit models, but how do we evaluate them? We can use resampling to compute performance metrics across some set of resamples, like the cross-validation splits we create here. The function <code>fit_resamples()</code> fits a model such as <code>glm_spec</code> to the analysis subset of each resample and evaluates on the heldout bit (the assessment subset) from each resample. We can use <code>metrics = metric_set()</code> to specify which metrics we want to compute if we don&rsquo;t want to only use the default ones; here let&rsquo;s check out sensitivity and specificity.</p>
<p>Originally in the video, I set up the resampled folds like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">set.seed</span>(<span style="color:#40a070">123</span>)
folds <span style="color:#666">&lt;-</span> <span style="color:#06287e">vfold_cv</span>(uni_juiced, strata <span style="color:#666">=</span> diversity)
</code></pre></div><p>But some helpful folks pointed out that this can result in overly optimistic results from resampling (i.e. data leakage) because of some of the recipe steps. It&rsquo;s better to resample the original training data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">set.seed</span>(<span style="color:#40a070">123</span>)
folds <span style="color:#666">&lt;-</span> <span style="color:#06287e">vfold_cv</span>(uni_train, strata <span style="color:#666">=</span> diversity)
</code></pre></div><p>After we have these folds, we can use <code>fit_resamples()</code> with the recipe to estimate model metrics.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">set.seed</span>(<span style="color:#40a070">234</span>)
glm_rs <span style="color:#666">&lt;-</span> glm_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit_resamples</span>(
    uni_rec,
    folds,
    metrics <span style="color:#666">=</span> <span style="color:#06287e">metric_set</span>(roc_auc, sens, spec),
    control <span style="color:#666">=</span> <span style="color:#06287e">control_resamples</span>(save_pred <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">TRUE</span>)
  )

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">234</span>)
knn_rs <span style="color:#666">&lt;-</span> knn_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit_resamples</span>(
    uni_rec,
    folds,
    metrics <span style="color:#666">=</span> <span style="color:#06287e">metric_set</span>(roc_auc, sens, spec),
    control <span style="color:#666">=</span> <span style="color:#06287e">control_resamples</span>(save_pred <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">TRUE</span>)
  )

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">234</span>)
tree_rs <span style="color:#666">&lt;-</span> tree_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit_resamples</span>(
    uni_rec,
    folds,
    metrics <span style="color:#666">=</span> <span style="color:#06287e">metric_set</span>(roc_auc, sens, spec),
    control <span style="color:#666">=</span> <span style="color:#06287e">control_resamples</span>(save_pred <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">TRUE</span>)
  )
</code></pre></div><p>What do these results look like?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">tree_rs
</code></pre></div><pre tabindex="0"><code>## #  10-fold cross-validation using stratification
## # A tibble: 10 x 5
##    splits             id     .metrics         .notes           .predictions
##    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;           &lt;list&gt;
##  1 &lt;split [1.5K/163]&gt; Fold01 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [163 × 5…
##  2 &lt;split [1.5K/162]&gt; Fold02 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  3 &lt;split [1.5K/162]&gt; Fold03 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  4 &lt;split [1.5K/162]&gt; Fold04 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  5 &lt;split [1.5K/162]&gt; Fold05 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  6 &lt;split [1.5K/162]&gt; Fold06 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  7 &lt;split [1.5K/162]&gt; Fold07 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  8 &lt;split [1.5K/162]&gt; Fold08 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
##  9 &lt;split [1.5K/162]&gt; Fold09 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [162 × 5…
## 10 &lt;split [1.5K/161]&gt; Fold10 &lt;tibble [3 × 3]&gt; &lt;tibble [0 × 1]&gt; &lt;tibble [161 × 5…
</code></pre><p>We can use <code>collect_metrics()</code> to see the summarized performance metrics for each set of resamples.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_rs <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">collect_metrics</span>()
</code></pre></div><pre tabindex="0"><code>## # A tibble: 3 x 5
##   .metric .estimator  mean     n std_err
##   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
## 1 roc_auc binary     0.758    10 0.00891
## 2 sens    binary     0.617    10 0.0179
## 3 spec    binary     0.737    10 0.00677
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">knn_rs <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">collect_metrics</span>()
</code></pre></div><pre tabindex="0"><code>## # A tibble: 3 x 5
##   .metric .estimator  mean     n std_err
##   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
## 1 roc_auc binary     0.728    10 0.00652
## 2 sens    binary     0.595    10 0.00978
## 3 spec    binary     0.733    10 0.0121
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">tree_rs <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">collect_metrics</span>()
</code></pre></div><pre tabindex="0"><code>## # A tibble: 3 x 5
##   .metric .estimator  mean     n std_err
##   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
## 1 roc_auc binary     0.723    10 0.00578
## 2 sens    binary     0.642    10 0.0182
## 3 spec    binary     0.745    10 0.00941
</code></pre><p>In realistic situations, we often care more about one of sensitivity or specificity than overall accuracy.</p>
<p>What does the ROC curve look like for these models?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_rs <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">unnest</span>(.predictions) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;glm&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bind_rows</span>(knn_rs <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">unnest</span>(.predictions) <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">mutate</span>(model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;knn&#34;</span>)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bind_rows</span>(tree_rs <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">unnest</span>(.predictions) <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">mutate</span>(model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;rpart&#34;</span>)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">group_by</span>(model) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">roc_curve</span>(diversity, .pred_high) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(x <span style="color:#666">=</span> <span style="color:#40a070">1</span> <span style="color:#666">-</span> specificity, y <span style="color:#666">=</span> sensitivity, color <span style="color:#666">=</span> model)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_line</span>(size <span style="color:#666">=</span> <span style="color:#40a070">1.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_abline</span>(
    lty <span style="color:#666">=</span> <span style="color:#40a070">2</span>, alpha <span style="color:#666">=</span> <span style="color:#40a070">0.5</span>,
    color <span style="color:#666">=</span> <span style="color:#4070a0">&#34;gray50&#34;</span>,
    size <span style="color:#666">=</span> <span style="color:#40a070">1.2</span>
  )
</code></pre></div><img src="/blog/2020/2020-03-10-tuition-resampling_files/figure-html/unnamed-chunk-13-1.png" width="2400" />
<p>If we decide the logistic regression model is the best fit for our purposes, we can look at the parameters in detail.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_fit <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">tidy</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">arrange</span>(<span style="color:#666">-</span>estimate)
</code></pre></div><pre tabindex="0"><code>## # A tibble: 9 x 5
##   term                  estimate std.error statistic  p.value
##   &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 out_of_state_total       0.507    0.0934     5.43  5.58e- 8
## 2 (Intercept)              0.370    0.0572     6.47  9.72e-11
## 3 region_North.Central     0.300    0.0825     3.64  2.72e- 4
## 4 degree_length_X4.Year    0.208    0.0863     2.41  1.58e- 2
## 5 type_Public              0.206    0.193      1.07  2.86e- 1
## 6 type_Private            -0.166    0.197     -0.838 4.02e- 1
## 7 total_enrollment        -0.458    0.0737    -6.22  5.07e-10
## 8 region_South            -0.517    0.0782    -6.62  3.64e-11
## 9 region_West             -0.536    0.0724    -7.41  1.27e-13
</code></pre><p>Larger, less expensive schools in the South and West are more likely to have higher proportions of minority students.</p>
<p>Finally, we can return to our test data as a last, unbiased check on how we can expect this model to perform on new data. We <code>bake()</code> our recipe using the testing set to apply the same preprocessing steps that we used on the training data.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_fit <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">predict</span>(
    new_data <span style="color:#666">=</span> <span style="color:#06287e">bake</span>(uni_prep, uni_test),
    type <span style="color:#666">=</span> <span style="color:#4070a0">&#34;prob&#34;</span>
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(truth <span style="color:#666">=</span> uni_test<span style="color:#666">$</span>diversity) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">roc_auc</span>(truth, .pred_high)
</code></pre></div><pre tabindex="0"><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 roc_auc binary         0.756
</code></pre><p>We can also explore other metrics with the test set, such as specificity.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">glm_fit <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">predict</span>(
    new_data <span style="color:#666">=</span> <span style="color:#06287e">bake</span>(uni_prep, new_data <span style="color:#666">=</span> uni_test),
    type <span style="color:#666">=</span> <span style="color:#4070a0">&#34;class&#34;</span>
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(truth <span style="color:#666">=</span> uni_test<span style="color:#666">$</span>diversity) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">spec</span>(truth, .pred_class)
</code></pre></div><pre tabindex="0"><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 spec    binary         0.719
</code></pre><p>Our metrics for the test set agree pretty well with what we found from resampling, indicating we had a good estimate of how the model will perform on new data.</p>

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">March 10, 2020</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">11 minute read, 2227 words</dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Categories:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Tags:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/tags/rstats">rstats</a>  <a href="https://juliasilge.com/tags/tidymodels">tidymodels</a> </dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
    <dd class="fw5 ml0"><a href="/blog/educational-attainment/">Educational attainment in #TidyTuesday UK towns</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/polling-places/">Changes in #TidyTuesday US polling places</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/doctor-who-bayes/">Empirical Bayes for #TidyTuesday Doctor Who episodes</a></dd>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
    <a class="prev dtc pr2 tl v-top fw6"
    href="https://juliasilge.com/blog/lasso-the-office/">&larr; LASSO regression using tidymodels and #TidyTuesday data for The Office</a>
  
  
  
    <a class="next dtc pl2 tr v-top fw6"
    href="https://juliasilge.com/blog/food-hyperparameter-tune/">Hyperparameter tuning and #TidyTuesday food consumption &rarr;</a>
  
</div>

      </footer>
    </article>
    
      
<div class="post-comments pa0 pa4-l mt4">
  
  <script src="https://utteranc.es/client.js"
          repo="juliasilge/juliasilge.com"
          issue-term="title"
          theme="github-light"
          label="comments :speech_balloon:"
          crossorigin="anonymous"
          async
          type="text/javascript">
  </script>
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2024 Julia Silge
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
    </div>
  </nav>
  
    <script>

    var i, text, code, codes = document.getElementsByTagName('code');
    for (let i = 0; i < codes.length;) {
      code = codes[i];
      if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
        text = code.textContent;
        if (/^\$[^$]/.test(text) && /[^$]\$$/.test(text)) {
          text = text.replace(/^\$/, '\\(').replace(/\$$/, '\\)');
          code.textContent = text;
        }
        if (/^\\\((.|\s)+\\\)$/.test(text) ||
            /^\\\[(.|\s)+\\\]$/.test(text) ||
            /^\$(.|\s)+\$$/.test(text) ||
            /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
          code.outerHTML = code.innerHTML;  
          continue;
        }
      }
      i++;
    }
</script>

  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>



    
  
  
</footer>

      </div>
    </body>
</html>
