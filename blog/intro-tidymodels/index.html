<!DOCTYPE html>
<html lang="en" dir="ltr"><head>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.91.2" />
<title>#TidyTuesday and tidymodels | Julia Silge</title>


<meta property="twitter:site" content="@juliasilge">
<meta property="twitter:creator" content="@juliasilge">







  
    
  
<meta name="description" content="A data science blog">


<meta property="og:site_name" content="Julia Silge">
<meta property="og:title" content="#TidyTuesday and tidymodels | Julia Silge">
<meta property="og:description" content="A data science blog" />
<meta property="og:type" content="page" />
<meta property="og:url" content="https://juliasilge.com/blog/intro-tidymodels/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="https://juliasilge.com/img/illustrated_blog_avatar.png" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https://juliasilge.com/img/illustrated_blog_avatar.png" >
    
  <meta itemprop="name" content="#TidyTuesday and tidymodels">
<meta itemprop="description" content="This week I started my new job as a software engineer at RStudio, working with Max Kuhn and other folks on tidymodels. I am really excited about tidymodels because my own experience as a practicing data scientist has shown me some of the areas for growth that still exist in open source software when it comes to modeling and machine learning. Almost nothing has had the kind of dramatic impact on my productivity that the tidyverse and other RStudio investments have had; I am enthusiastic about contributing to that kind of user-focused transformation for modeling and machine learning."><meta itemprop="datePublished" content="2020-02-05T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-02-05T00:00:00+00:00" />
<meta itemprop="wordCount" content="2072">
<meta itemprop="keywords" content="rstats,tidymodels," />
  
  
  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/icon.png" type="image/x-icon">
  <link rel="icon" href="/img/icon.png" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.34750661ca065ca7ddb87b2b28cab82abf493a21c1e3852e0755fba776b031b7.css" integrity="sha256-NHUGYcoGXKfduHsrKMq4Kr9JOiHB44UuB1X7p3awMbc=" media="screen">
  
  
  <script src="/panelset.min.078a92db9bd3228df502db3d9e0453c3cf3d910abe3f8deca0ad196c7071ad41.js" type="text/javascript"></script>
  
  
  <script src="/main.min.bb67dea4a2ee41aab688effd180f2d02662e47280f0021495f2c0ce24c461f65.js" type="text/javascript"></script>
</head>
<body>
      <div class="grid-container">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="https://juliasilge.com/" title="Home">
      <span class="f4 fw7">Julia Silge</span>
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About me">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4">#TidyTuesday and tidymodels</h1>
        
        <p class="f6 measure lh-copy mv1">By Julia Silge in <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </p>
        <p class="f7 db mv0 ttu">February 5, 2020</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>This week I started my new job as a software engineer at RStudio, working with Max Kuhn and other folks on 
<a href="https://www.tidyverse.org/blog/2018/08/tidymodels-0-0-1/" target="_blank" rel="noopener">tidymodels</a>. I am really excited about tidymodels because my own experience as a practicing data scientist has shown me some of the areas for growth that still exist in open source software when it comes to modeling and machine learning. Almost nothing has had the kind of dramatic impact on my productivity that the tidyverse and other RStudio investments have had; I am enthusiastic about contributing to that kind of user-focused transformation for modeling and machine learning.</p>
<p>The tidymodels ecosystem is still maturing, but with the release of 
<a href="https://github.com/tidymodels/tune" target="_blank" rel="noopener">tune</a> is becoming an option for modeling workflows in the real world. I am still getting my bearings with tidymodels and where current development is happening (and headed next!) but I want to start showing how to use tidymodels in some easy-to-digest ways. Today, I&rsquo;m using this week&rsquo;s 
<a href="https://github.com/rfordatascience/tidytuesday" target="_blank" rel="noopener"><code>#TidyTuesday</code> dataset</a> to show how to get started with some simple models!</p>
<!--html_preserve-->
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube-nocookie.com/embed/LPptRkGoYMg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>
<!--/html_preserve-->
</br>
<p>Here is the code I used in the video, for those who prefer reading instead of or in addition to video.</p>




<h2 id="explore-data">Explore data
  <a href="#explore-data"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Our goal here is to build some very simple models for 
<a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-04/readme.md" target="_blank" rel="noopener">NFL attendance from this week&rsquo;s <code>#TidyTuesday</code> dataset</a>. First, we&rsquo;ll read in the two files and join them together.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidyverse)

attendance <span style="color:#666">&lt;-</span> <span style="color:#06287e">read_csv</span>(<span style="color:#4070a0">&#34;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-04/attendance.csv&#34;</span>)
standings <span style="color:#666">&lt;-</span> <span style="color:#06287e">read_csv</span>(<span style="color:#4070a0">&#34;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-04/standings.csv&#34;</span>)

attendance_joined <span style="color:#666">&lt;-</span> attendance <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">left_join</span>(standings,
    by <span style="color:#666">=</span> <span style="color:#06287e">c</span>(<span style="color:#4070a0">&#34;year&#34;</span>, <span style="color:#4070a0">&#34;team_name&#34;</span>, <span style="color:#4070a0">&#34;team&#34;</span>)
  )

attendance_joined
</code></pre></div><pre tabindex="0"><code>## # A tibble: 10,846 x 20
##    team  team_name  year  total   home   away  week weekly_attendan…  wins  loss
##    &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Ariz… Cardinals  2000 893926 387475 506451     1            77434     3    13
##  2 Ariz… Cardinals  2000 893926 387475 506451     2            66009     3    13
##  3 Ariz… Cardinals  2000 893926 387475 506451     3               NA     3    13
##  4 Ariz… Cardinals  2000 893926 387475 506451     4            71801     3    13
##  5 Ariz… Cardinals  2000 893926 387475 506451     5            66985     3    13
##  6 Ariz… Cardinals  2000 893926 387475 506451     6            44296     3    13
##  7 Ariz… Cardinals  2000 893926 387475 506451     7            38293     3    13
##  8 Ariz… Cardinals  2000 893926 387475 506451     8            62981     3    13
##  9 Ariz… Cardinals  2000 893926 387475 506451     9            35286     3    13
## 10 Ariz… Cardinals  2000 893926 387475 506451    10            52244     3    13
## # … with 10,836 more rows, and 10 more variables: points_for &lt;dbl&gt;,
## #   points_against &lt;dbl&gt;, points_differential &lt;dbl&gt;, margin_of_victory &lt;dbl&gt;,
## #   strength_of_schedule &lt;dbl&gt;, simple_rating &lt;dbl&gt;, offensive_ranking &lt;dbl&gt;,
## #   defensive_ranking &lt;dbl&gt;, playoffs &lt;chr&gt;, sb_winner &lt;chr&gt;
</code></pre><p>You can read more at the 
<a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-04/readme.md#data-dictionary" target="_blank" rel="noopener">data dictionary</a>, but notice that we have information on weekly attendance at NFL games, along with characteristics of team records per season such as SRS (Simple Rating System), how many points were scored for/against teams, whether a team made the playoffs, and more. Let&rsquo;s build a model to predict <strong>weekly attendance</strong>.</p>
<p>How does weekly attendance vary for different teams, and for the seasons they did/did not make the playoffs?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">attendance_joined <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(<span style="color:#666">!</span><span style="color:#06287e">is.na</span>(weekly_attendance)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(<span style="color:#06287e">fct_reorder</span>(team_name, weekly_attendance),
    weekly_attendance,
    fill <span style="color:#666">=</span> playoffs
  )) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_boxplot</span>(outlier.alpha <span style="color:#666">=</span> <span style="color:#40a070">0.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">coord_flip</span>() <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    fill <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>, x <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>,
    y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Weekly NFL game attendance&#34;</span>
  )
</code></pre></div><img src="/blog/2020/2020-02-05-intro-tidymodels_files/figure-html/attendance_playoffs-1.png" width="2400" />
<p>Notice that for the 32 teams in the NFL, we have years they all did and did not make the playoffs, which will be nice for modeling.</p>
<p>How much does <code>margin_of_victory</code>, a measure of points scored relative to points allowed, measure the same thing as getting to the playoffs?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">attendance_joined <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">distinct</span>(team_name, year, margin_of_victory, playoffs) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(margin_of_victory, fill <span style="color:#666">=</span> playoffs)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_histogram</span>(position <span style="color:#666">=</span> <span style="color:#4070a0">&#34;identity&#34;</span>, alpha <span style="color:#666">=</span> <span style="color:#40a070">0.7</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Margin of victory&#34;</span>,
    y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Number of teams&#34;</span>,
    fill <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>
  )
</code></pre></div><img src="/blog/2020/2020-02-05-intro-tidymodels_files/figure-html/margin_of_victory-1.png" width="2400" />
<p>Are there changes with the week of the season?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">attendance_joined <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(week <span style="color:#666">=</span> <span style="color:#06287e">factor</span>(week)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(week, weekly_attendance, fill <span style="color:#666">=</span> week)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_boxplot</span>(show.legend <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">FALSE</span>, outlier.alpha <span style="color:#666">=</span> <span style="color:#40a070">0.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Week of NFL season&#34;</span>,
    y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Weekly NFL game attendance&#34;</span>
  )
</code></pre></div><img src="/blog/2020/2020-02-05-intro-tidymodels_files/figure-html/unnamed-chunk-3-1.png" width="2400" />
<p>Maybe a bit.</p>
<p>This is some initial exploratory data analysis for this dataset, always an important part of a modeling task. To see more examples of EDA for this dataset, you can see the 
<a href="https://twitter.com/hashtag/tidytuesday" target="_blank" rel="noopener">amazing work that folks share on Twitter</a>. The next step for us here is to create a dataset for modeling.</p>
<ul>
<li>Let&rsquo;s remove the weeks that each team did not play (where the weekly attendance is <code>NA</code>).</li>
<li>Let&rsquo;s only keep columns for modeling that we want to use for modeling. For example, we will keep <code>margin_of_victory</code> and <code>strength_of_schedule</code>, but not <code>simple_rating</code> which is the sum of those first two quantities.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">attendance_df <span style="color:#666">&lt;-</span> attendance_joined <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">filter</span>(<span style="color:#666">!</span><span style="color:#06287e">is.na</span>(weekly_attendance)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">select</span>(
    weekly_attendance, team_name, year, week,
    margin_of_victory, strength_of_schedule, playoffs
  )

attendance_df
</code></pre></div><pre tabindex="0"><code>## # A tibble: 10,208 x 7
##    weekly_attendan… team_name  year  week margin_of_victo… strength_of_sch…
##               &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
##  1            77434 Cardinals  2000     1            -14.6             -0.7
##  2            66009 Cardinals  2000     2            -14.6             -0.7
##  3            71801 Cardinals  2000     4            -14.6             -0.7
##  4            66985 Cardinals  2000     5            -14.6             -0.7
##  5            44296 Cardinals  2000     6            -14.6             -0.7
##  6            38293 Cardinals  2000     7            -14.6             -0.7
##  7            62981 Cardinals  2000     8            -14.6             -0.7
##  8            35286 Cardinals  2000     9            -14.6             -0.7
##  9            52244 Cardinals  2000    10            -14.6             -0.7
## 10            64223 Cardinals  2000    11            -14.6             -0.7
## # … with 10,198 more rows, and 1 more variable: playoffs &lt;chr&gt;
</code></pre>



<h2 id="build-simple-models">Build simple models
  <a href="#build-simple-models"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Now it is time to load the 
<a href="https://github.com/tidymodels/tidymodels" target="_blank" rel="noopener">tidymodels</a> metapackage! 💪 The first step here is to split our data into training and testing tests. We can use <code>initial_split()</code> to create these datasets, divided so that they each have about the same number of examples of teams that went on to the playoffs.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">library</span>(tidymodels)

<span style="color:#06287e">set.seed</span>(<span style="color:#40a070">1234</span>)
attendance_split <span style="color:#666">&lt;-</span> attendance_df <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">initial_split</span>(strata <span style="color:#666">=</span> playoffs)

nfl_train <span style="color:#666">&lt;-</span> <span style="color:#06287e">training</span>(attendance_split)
nfl_test <span style="color:#666">&lt;-</span> <span style="color:#06287e">testing</span>(attendance_split)
</code></pre></div><p>Now we can <strong>specify</strong> and then <strong>fit</strong> our models. One of the significant problems that tidymodels solves is how so many modeling packages and functions in R have different inputs, calling sequences, and outputs. The code below might look like overkill to fit linear regression using OLS, but we can use the same framework to fit a regression model using Stan, using regularization, etc. The functions in tidymodels are designed to be composable and consistent.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">linear_reg</span>() <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(engine <span style="color:#666">=</span> <span style="color:#4070a0">&#34;lm&#34;</span>)

lm_spec
</code></pre></div><pre tabindex="0"><code>## Linear Regression Model Specification (regression)
##
## Computational engine: lm
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">lm_fit <span style="color:#666">&lt;-</span> lm_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit</span>(weekly_attendance <span style="color:#666">~</span> .,
    data <span style="color:#666">=</span> nfl_train
  )

lm_fit
</code></pre></div><pre tabindex="0"><code>## parsnip model object
##
## Fit time:  16ms
##
## Call:
## stats::lm(formula = formula, data = data)
##
## Coefficients:
##          (Intercept)        team_nameBears      team_nameBengals
##            -81107.86              -2879.80              -4875.47
##       team_nameBills      team_nameBroncos       team_nameBrowns
##              -361.08               2805.24               -324.11
##  team_nameBuccaneers    team_nameCardinals     team_nameChargers
##             -3063.65              -6139.80              -6489.31
##      team_nameChiefs        team_nameColts      team_nameCowboys
##              1974.33              -3392.79               6068.70
##    team_nameDolphins       team_nameEagles      team_nameFalcons
##               139.68               1259.16               -204.17
##      team_nameGiants      team_nameJaguars         team_nameJets
##              5447.10              -3095.46               4044.23
##       team_nameLions      team_namePackers     team_namePanthers
##             -3480.69               1114.11               1227.32
##    team_namePatriots      team_nameRaiders         team_nameRams
##              -214.20              -6324.74              -2884.85
##      team_nameRavens     team_nameRedskins       team_nameSaints
##              -398.90               6447.07                380.98
##    team_nameSeahawks     team_nameSteelers       team_nameTexans
##             -1405.89              -3567.81                264.07
##      team_nameTitans      team_nameVikings                  year
##             -1118.23              -3183.08                 74.73
##                 week     margin_of_victory  strength_of_schedule
##               -72.83                137.58                230.74
##     playoffsPlayoffs
##              -427.94
</code></pre><p>So that&rsquo;s one model! Let&rsquo;s fit another one.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rf_spec <span style="color:#666">&lt;-</span> <span style="color:#06287e">rand_forest</span>(mode <span style="color:#666">=</span> <span style="color:#4070a0">&#34;regression&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">set_engine</span>(<span style="color:#4070a0">&#34;ranger&#34;</span>)

rf_spec
</code></pre></div><pre tabindex="0"><code>## Random Forest Model Specification (regression)
##
## Computational engine: ranger
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rf_fit <span style="color:#666">&lt;-</span> rf_spec <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">fit</span>(weekly_attendance <span style="color:#666">~</span> .,
    data <span style="color:#666">=</span> nfl_train
  )

rf_fit
</code></pre></div><pre tabindex="0"><code>## parsnip model object
##
## Fit time:  2.2s
## Ranger result
##
## Call:
##  ranger::ranger(formula = formula, data = data, num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1))
##
## Type:                             Regression
## Number of trees:                  500
## Sample size:                      7656
## Number of independent variables:  6
## Mtry:                             2
## Target node size:                 5
## Variable importance mode:         none
## Splitrule:                        variance
## OOB prediction error (MSE):       74737868
## R squared (OOB):                  0.08217606
</code></pre><p>Notice that we have fit both of these models using <code>nfl_train</code>, the training data. We haven&rsquo;t touched the testing data during training.</p>




<h2 id="evaluate-models">Evaluate models
  <a href="#evaluate-models"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>When it&rsquo;s time to evaluate our models (to estimate how well our models will perform on new data), then we will look at <code>nfl_test</code>. We can <code>predict()</code> what the weekly attendance will be for both the training data and the testing data using both the OLS and random forest models. One of the goals of tidymodels is to be able to use code like the following in predictable, consistent ways for many kinds of models, and to use existing well-suited tidyverse tools for these kinds of tasks.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">results_train <span style="color:#666">&lt;-</span> lm_fit <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">predict</span>(new_data <span style="color:#666">=</span> nfl_train) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(
    truth <span style="color:#666">=</span> nfl_train<span style="color:#666">$</span>weekly_attendance,
    model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;lm&#34;</span>
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bind_rows</span>(rf_fit <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">predict</span>(new_data <span style="color:#666">=</span> nfl_train) <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">mutate</span>(
      truth <span style="color:#666">=</span> nfl_train<span style="color:#666">$</span>weekly_attendance,
      model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;rf&#34;</span>
    ))

results_test <span style="color:#666">&lt;-</span> lm_fit <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">predict</span>(new_data <span style="color:#666">=</span> nfl_test) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(
    truth <span style="color:#666">=</span> nfl_test<span style="color:#666">$</span>weekly_attendance,
    model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;lm&#34;</span>
  ) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bind_rows</span>(rf_fit <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">predict</span>(new_data <span style="color:#666">=</span> nfl_test) <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">mutate</span>(
      truth <span style="color:#666">=</span> nfl_test<span style="color:#666">$</span>weekly_attendance,
      model <span style="color:#666">=</span> <span style="color:#4070a0">&#34;rf&#34;</span>
    ))
</code></pre></div><p>For this regression model, let&rsquo;s look at the 
<a href="https://tidymodels.github.io/yardstick/reference/rmse.html" target="_blank" rel="noopener"><code>rmse</code></a> for what we&rsquo;ve done so far.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">results_train <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">group_by</span>(model) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">rmse</span>(truth <span style="color:#666">=</span> truth, estimate <span style="color:#666">=</span> .pred)
</code></pre></div><pre tabindex="0"><code>## # A tibble: 2 x 4
##   model .metric .estimator .estimate
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 lm    rmse    standard       8307.
## 2 rf    rmse    standard       6102.
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">results_test <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">group_by</span>(model) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">rmse</span>(truth <span style="color:#666">=</span> truth, estimate <span style="color:#666">=</span> .pred)
</code></pre></div><pre tabindex="0"><code>## # A tibble: 2 x 4
##   model .metric .estimator .estimate
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 lm    rmse    standard       8351.
## 2 rf    rmse    standard       8582.
</code></pre><p>If we look at the training data, the random forest model performed much better than the linear model; the <code>rmse</code> is much lower. However, the same cannot be said for the testing data! 😭 The metric for training and testing for the linear model is about the same, meaning that we have not overfit. For the random forest model, the <code>rmse</code> is <em>higher</em> for the testing data than for the training data, by quite a lot. Our training data is not giving us a good idea of how our model is going to perform, and this powerful ML algorithm has overfit to this dataset.</p>
<p>Let&rsquo;s visualize our sad situation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">results_test <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">mutate</span>(train <span style="color:#666">=</span> <span style="color:#4070a0">&#34;testing&#34;</span>) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">bind_rows</span>(results_train <span style="color:#666">%&gt;%</span>
    <span style="color:#06287e">mutate</span>(train <span style="color:#666">=</span> <span style="color:#4070a0">&#34;training&#34;</span>)) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(truth, .pred, color <span style="color:#666">=</span> model)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_abline</span>(lty <span style="color:#666">=</span> <span style="color:#40a070">2</span>, color <span style="color:#666">=</span> <span style="color:#4070a0">&#34;gray80&#34;</span>, size <span style="color:#666">=</span> <span style="color:#40a070">1.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_point</span>(alpha <span style="color:#666">=</span> <span style="color:#40a070">0.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">facet_wrap</span>(<span style="color:#666">~</span>train) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Truth&#34;</span>,
    y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Predicted attendance&#34;</span>,
    color <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Type of model&#34;</span>
  )
</code></pre></div><img src="/blog/2020/2020-02-05-intro-tidymodels_files/figure-html/sad_results-1.png" width="3000" />




<h2 id="lets-try-this-again">Let&rsquo;s try this again!
  <a href="#lets-try-this-again"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>We made not such a great decision in the previous section; we expected the random forest model evaluated one time on the whole training set to help us understand something about how it would perform on new data. This would be a reasonable expectation for the linear model, but not for the random forest. Fortunately, we have some options. We can <strong>resample</strong> the training set to produce an estimate of how the model will perform. Let&rsquo;s divide our training set <code>nfl_train</code> into folds (say, 10) and fit 10 versions of our model (each one trained on nine folds and evaluated on one heldout fold). Then let&rsquo;s measure how well our model(s) performs. The function <code>vfold_cv()</code> creates folds for cross-validation, the function <code>fit_resamples()</code> fits models to resamples such as these (to measure performance), and then we can <code>collect_metrics()</code> from the result.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#06287e">set.seed</span>(<span style="color:#40a070">1234</span>)
nfl_folds <span style="color:#666">&lt;-</span> <span style="color:#06287e">vfold_cv</span>(nfl_train, strata <span style="color:#666">=</span> playoffs)

rf_res <span style="color:#666">&lt;-</span> <span style="color:#06287e">fit_resamples</span>(
  weekly_attendance <span style="color:#666">~</span> .,
  rf_spec,
  nfl_folds,
  control <span style="color:#666">=</span> <span style="color:#06287e">control_resamples</span>(save_pred <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">TRUE</span>)
)

rf_res <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">collect_metrics</span>()
</code></pre></div><pre tabindex="0"><code>## # A tibble: 2 x 5
##   .metric .estimator     mean     n   std_err
##   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt;
## 1 rmse    standard   8255.       10 115.
## 2 rsq     standard      0.164    10   0.00988
</code></pre><p>Remember that this is still the <strong>training</strong> dataset. We would take this step instead of the chunk above with <code>predict(new_data = nfl_train)</code>, and we would still compare to how the model performs on the testing data. Notice that now we have a realistic estimate from the training data that is close to the testing data! We can even visualize our model results for the resamples.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rf_res <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">unnest</span>(.predictions) <span style="color:#666">%&gt;%</span>
  <span style="color:#06287e">ggplot</span>(<span style="color:#06287e">aes</span>(weekly_attendance, .pred, color <span style="color:#666">=</span> id)) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_abline</span>(lty <span style="color:#666">=</span> <span style="color:#40a070">2</span>, color <span style="color:#666">=</span> <span style="color:#4070a0">&#34;gray80&#34;</span>, size <span style="color:#666">=</span> <span style="color:#40a070">1.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">geom_point</span>(alpha <span style="color:#666">=</span> <span style="color:#40a070">0.5</span>) <span style="color:#666">+</span>
  <span style="color:#06287e">labs</span>(
    x <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Truth&#34;</span>,
    y <span style="color:#666">=</span> <span style="color:#4070a0">&#34;Predicted game attendance&#34;</span>,
    color <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">NULL</span>
  )
</code></pre></div><img src="/blog/2020/2020-02-05-intro-tidymodels_files/figure-html/resample_results-1.png" width="2400" />




<h2 id="summary">Summary
  <a href="#summary"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Let me know if you have questions or feedback about this introduction to tidymodels and how to get started. I hope to do some more screencasts and blog posts about getting started with tidymodels, perhaps with more <code>#TidyTuesday</code> data!</p>

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">February 5, 2020</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">10 minute read, 2072 words</dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Categories:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/categories/rstats">rstats</a>  <a href="https://juliasilge.com/categories/tidymodels">tidymodels</a> </dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Tags:</dt>
    <dd class="fw5 ml0"> <a href="https://juliasilge.com/tags/rstats">rstats</a>  <a href="https://juliasilge.com/tags/tidymodels">tidymodels</a> </dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
    <dd class="fw5 ml0"><a href="/blog/educational-attainment/">Educational attainment in #TidyTuesday UK towns</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/polling-places/">Changes in #TidyTuesday US polling places</a></dd>
    
    <dd class="fw5 ml0"><a href="/blog/doctor-who-bayes/">Empirical Bayes for #TidyTuesday Doctor Who episodes</a></dd>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
    <a class="prev dtc pr2 tl v-top fw6"
    href="https://juliasilge.com/blog/hotels-recipes/">&larr; #TidyTuesday hotel bookings and recipes</a>
  
  
  
    <a class="next dtc pl2 tr v-top fw6"
    href="https://juliasilge.com/blog/salary-gender/">Modeling salary and gender in the tech industry &rarr;</a>
  
</div>

      </footer>
    </article>
    
      
<div class="post-comments pa0 pa4-l mt4">
  
  <script src="https://utteranc.es/client.js"
          repo="juliasilge/juliasilge.com"
          issue-term="title"
          theme="github-light"
          label="comments :speech_balloon:"
          crossorigin="anonymous"
          async
          type="text/javascript">
  </script>
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2024 Julia Silge
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
    </div>
  </nav>
  
    <script>

    var i, text, code, codes = document.getElementsByTagName('code');
    for (let i = 0; i < codes.length;) {
      code = codes[i];
      if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
        text = code.textContent;
        if (/^\$[^$]/.test(text) && /[^$]\$$/.test(text)) {
          text = text.replace(/^\$/, '\\(').replace(/\$$/, '\\)');
          code.textContent = text;
        }
        if (/^\\\((.|\s)+\\\)$/.test(text) ||
            /^\\\[(.|\s)+\\\]$/.test(text) ||
            /^\$(.|\s)+\$$/.test(text) ||
            /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
          code.outerHTML = code.innerHTML;  
          continue;
        }
      }
      i++;
    }
</script>

  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>



    
  
  
</footer>

      </div>
    </body>
</html>
